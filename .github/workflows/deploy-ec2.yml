name: 2. Deploy to EC2

on:
  workflow_run:
    workflows: ["1. Build and Push Images"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd ~/SL_UNIVERSITY

            # Make sure repo is up to date (assumes you cloned the repo on the EC2)
            git pull origin main

            # Download latest images from Docker Hub
            docker compose pull

            # Restart using updated images
            docker compose up -d

            # Cleanup old images to free space
            docker image prune -f
